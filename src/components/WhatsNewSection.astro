---
type MediaItem =
  | { type: "image"; src: string; alt?: string }
  | { type: "video"; src: string; poster?: string; alt?: string };

type Props = {
  rows: [MediaItem[], MediaItem[], MediaItem[]];
};

const { rows } = Astro.props;
const safeRows: [MediaItem[], MediaItem[], MediaItem[]] =
  rows?.length === 3 ? rows : [[], [], []];
---

<section id="" class="wn" aria-label="What's new">
<h1 class="mobile-only">WHAT‚ÄôS<br>NEW AT<br>BOLDMOVE?</h1>
  <div class="wn__inner">
    <div class="wn__bg mobile-only" aria-hidden="true">
    
      <video
        class="wn__bgVideo"
        src="/uploads/video1.mp4"
        autoplay
        muted
        loop
        playsinline
        preload="metadata"
      ></video>
    </div>

    {safeRows.map((rowItems, rowIndex) => (
      <div class="wn__row" data-dir={rowIndex === 1 ? "rtl" : "ltr"}>
        <div class="wn__track">
          {rowItems.map((it, cardIndex) => {
            const isSpecialCard = rowIndex === 1 && cardIndex === 6;
            return (
              <figure class="wn__card" class:list={{ "wn__card--special": isSpecialCard }} role="group" aria-label={it.alt ?? "Media"}>
                {it.type === "video" ? (
                  <video
                    class="wn__media"
                    src={it.src}
                    poster={it.poster}
                    muted
                    autoplay
                    loop
                    playsinline
                    preload="metadata"
                  />
                ) : (
                  <img class="wn__media" src={it.src} alt={it.alt ?? ""} loading="lazy" />
                )}

                {isSpecialCard && (
                  <>
                    <div class="wn__cardOverlay"></div>
                    <div class="wn__cardTitle">
                      <div class="desktop-only">
                        <span>WHAT'S NEW</span>
                        <span>AT BOLDMOVE?</span>
                      </div>
                    </div>
                  </>
                )}
              </figure>
            );
          })}
        </div>
      </div>
    ))}
  </div>

  <script is:inline>
  (function () {
    const root = document.currentScript?.closest(".wn");
    if (!root) return;

    const rows = Array.from(root.querySelectorAll(".wn__row"));
    const specialCard = root.querySelector(".wn__card--special");
    const navEls = document.querySelectorAll(".navigation");
    const arrowEls = document.querySelectorAll(".arrow");
    const cardOverlay = specialCard?.querySelector(".wn__cardOverlay");
    const cardTitle = specialCard?.querySelector(".wn__cardTitle");

    const TRIGGER_ID = "whats-new-scroll";
    const DESKTOP_MQ = "(min-width: 991px)";

    function measureTravel(row) {
      const track = row.querySelector(".wn__track");
      if (!track) return 0;
      const vw = row.getBoundingClientRect().width;
      const sw = track.scrollWidth;
      return Math.max(0, sw - vw);
    }

    function queueRefresh() {
      if (!window.ScrollTrigger) return;
      if (window.__wnRefreshQueued) return;
      window.__wnRefreshQueued = true;
      requestAnimationFrame(() => {
        window.__wnRefreshQueued = false;
        window.ScrollTrigger.refresh();
      });
    }

    function killDesktop() {
      if (!window.ScrollTrigger || !window.gsap) return;
      const gsap = window.gsap;

      // mata SOLO el trigger de esta secci√≥n
      window.ScrollTrigger.getById(TRIGGER_ID)?.kill(true);

      // resetea transforms de las filas
      rows.forEach((row) => {
        const track = row.querySelector(".wn__track");
        if (track) gsap.set(track, { clearProps: "all" });
      });

      // resetea overlay/t√≠tulo
      if (cardOverlay) gsap.set(cardOverlay, { clearProps: "all" });
      if (cardTitle) gsap.set(cardTitle, { clearProps: "all" });

      // üîë IMPORTANT√çSIMO: reset UI global (si no, se queda ‚Äúpegado‚Äù en mobile)
      if (navEls.length) gsap.set(navEls, { clearProps: "opacity" });
      if (arrowEls.length) gsap.set(arrowEls, { clearProps: "opacity" });
    }

    function buildDesktop() {
      if (!window.gsap || !window.ScrollTrigger) return;
      if (rows.length !== 3) return;

      const gsap = window.gsap;
      const ScrollTrigger = window.ScrollTrigger;

      killDesktop();

      // Estado inicial (solo desktop)
      if (navEls.length) gsap.set(navEls, { opacity: 0 });
      if (arrowEls.length) gsap.set(arrowEls, { opacity: 1 });

      // T√≠tulo y overlay empiezan visibles
      if (cardTitle) gsap.set(cardTitle, { opacity: 1, y: 0 });
      if (cardOverlay) gsap.set(cardOverlay, { opacity: 1 });

      const progressRatio = 0.8;
      const travels = rows.map(measureTravel);
      const maxTravel = Math.max(...travels);
      if (maxTravel < 10) return;

      const effectiveTravel = maxTravel * progressRatio;

      const tl = gsap.timeline({ defaults: { ease: "none" } });

      // Fase A: filas
      rows.forEach((row, idx) => {
        const track = row.querySelector(".wn__track");
        if (!track) return;

        const travel = (travels[idx] || 0) * progressRatio;
        const dir = row.getAttribute("data-dir");

        const startOffset = -220;
        const endOffset = 0;

        if (dir === "rtl") {
          gsap.set(track, { x: -travel + startOffset });
          tl.to(track, { x: endOffset }, 0);
        } else {
          gsap.set(track, { x: 0 });
          tl.to(track, { x: -travel }, 0);
        }
      });

      // UI global al principio del scroll (desktop)
      if (navEls.length) {
        tl.to(navEls, { opacity: 1, duration: 0.1, ease: "power1.out" }, 0.05);
      }
      if (arrowEls.length) {
        tl.to(arrowEls, { opacity: 0, duration: 0.1, ease: "power1.out" }, 0.05);
      }

      const factor = 0.7;
      const extraHoldPx = Math.round(window.innerHeight * 0.3);

      ScrollTrigger.create({
        id: TRIGGER_ID,
        trigger: root,
        start: "top top",
        end: () => "+=" + Math.round(effectiveTravel * factor + extraHoldPx),
        pin: true,
        scrub: true,
        anticipatePin: 1,
        invalidateOnRefresh: true,
        animation: tl,
        refreshPriority: 0,
      });

      queueRefresh();
    }

    function initDesktopWhenReady() {
      const media = Array.from(root.querySelectorAll("img, video"));
      const pending = media.filter((el) => {
        if (el.tagName === "IMG") return !el.complete;
        return el.readyState < 1;
      });

      if (pending.length === 0) {
        buildDesktop();
        return;
      }

      let left = pending.length;
      const done = () => {
        left--;
        if (left <= 0) buildDesktop();
      };

      pending.forEach((el) => {
        if (el.tagName === "IMG") {
          el.addEventListener("load", done, { once: true });
          el.addEventListener("error", done, { once: true });
        } else {
          el.addEventListener("loadedmetadata", done, { once: true });
          el.addEventListener("error", done, { once: true });
        }
      });
    }

    function init() {
      const mq = window.matchMedia(DESKTOP_MQ);

      const apply = () => {
        if (mq.matches) {
          initDesktopWhenReady();
        } else {
          // mobile/tablet: aseg√∫rate de no arrastrar estados
          killDesktop();
        }
      };

      apply();
      mq.addEventListener?.("change", apply);

      let resizeTimeout;
      window.addEventListener("resize", () => {
        if (!mq.matches) return;
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          buildDesktop();
        }, 100);
      });
    }

    if (document.readyState === "complete") init();
    else window.addEventListener("load", init);
  })();
</script>

  <style>
  .wn h1 {
    margin: 15vh 0 0 2.8rem;
    font-family: 'Druk Cond LCG Super', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    text-transform: uppercase;
    font-size: 30vw;
    color: var(--color-secondary);
    padding: 0;
    line-height: 0.82;
  }
    .wn__card {
      position: relative;
    }

    .wn__cardOverlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 1);
      z-index: 1;
      pointer-events: none;
    }

    .wn__cardTitle {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      pointer-events: none;
      color: var(--color-secondary);
      font-family: 'Druk Cond LCG Super', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0;
      font-size: 6vw;
      margin-left: 1vw;
      text-align: left;
      line-height: 0.85;

    }

    .wn__cardTitle span {
      display: block;
    }
  </style>
</section>