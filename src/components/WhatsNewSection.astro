---
type MediaItem =
  | { type: "image"; src: string; alt?: string }
  | { type: "video"; src: string; poster?: string; alt?: string };

type Props = {
  rows: [MediaItem[], MediaItem[], MediaItem[]];
};

const { rows } = Astro.props;
const safeRows: [MediaItem[], MediaItem[], MediaItem[]] =
  rows?.length === 3 ? rows : [[], [], []];

const centerItem: MediaItem | null = safeRows?.[2]?.[2] ?? safeRows?.[2]?.[0] ?? null;
const centerAlt = centerItem?.alt ?? "What's new at Boldmove";
---

<section id="whats-new" class="wn" aria-label="What's new">
  <div class="wn__inner">
    {safeRows.map((rowItems, rowIndex) => (
      <div class="wn__row" data-dir={rowIndex === 1 ? "rtl" : "ltr"}>
        <div class="wn__track">
          {rowItems.map((it) => (
            <figure class="wn__card" role="group" aria-label={it.alt ?? "Media"}>
              {it.type === "video" ? (
                <video
                  class="wn__media"
                  src={it.src}
                  poster={it.poster}
                  muted
                  playsinline
                  preload="metadata"
                />
              ) : (
                <img class="wn__media" src={it.src} alt={it.alt ?? ""} loading="lazy" />
              )}
            </figure>
          ))}
        </div>
      </div>
    ))}

    <div class="wn__center" aria-hidden="true">
      <div class="wn__centerMedia">
        {centerItem ? (
          centerItem.type === "video" ? (
            <video
              class="wn__media"
              src={centerItem.src}
              poster={centerItem.poster}
              muted
              playsinline
              preload="metadata"
            />
          ) : (
            <img class="wn__media" src={centerItem.src} alt={centerAlt} loading="eager" />
          )
        ) : null}
      </div>

      <div class="wn__centerOverlay"></div>

      <div class="wn__centerTitle" aria-hidden="true">
        <div class="desktop-only">
            <span>WHAT'S NEW</span>
            <span>AT BOLDMOVE?</span>
        </div>
        <div class="mobile-only">
            <span>WHAT'S<br>NEW AT<br>BOLDMOVE?</span>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    (function () {
      const root = document.currentScript?.closest(".wn");
      if (!root) return;

      const rows = Array.from(root.querySelectorAll(".wn__row"));
      const centerOverlay = root.querySelector(".wn__centerOverlay");
      const centerTitle = root.querySelector(".wn__centerTitle");

      const TRIGGER_ID = "whats-new-scroll";
      const DESKTOP_MQ = "(min-width: 991px)";

      function measureTravel(row) {
        const track = row.querySelector(".wn__track");
        if (!track) return 0;
        const vw = row.getBoundingClientRect().width;
        const sw = track.scrollWidth;
        return Math.max(0, sw - vw);
      }

      function queueRefresh() {
        if (!window.ScrollTrigger) return;
        if (window.__wnRefreshQueued) return;
        window.__wnRefreshQueued = true;
        requestAnimationFrame(() => {
          window.__wnRefreshQueued = false;
          window.ScrollTrigger.refresh();
        });
      }

      function killDesktop() {
        if (!window.ScrollTrigger || !window.gsap) return;

        window.ScrollTrigger.getById(TRIGGER_ID)?.kill(true);

        // Limpia transforms
        rows.forEach((row) => {
          const track = row.querySelector(".wn__track");
          if (track) window.gsap.set(track, { clearProps: "all" });
        });

        if (centerOverlay) window.gsap.set(centerOverlay, { clearProps: "all", opacity: 0 });
        if (centerTitle) window.gsap.set(centerTitle, { clearProps: "all", opacity: 1, y: 0 });
      }

      function buildDesktop() {
        if (!window.gsap || !window.ScrollTrigger) return;
        if (rows.length !== 3) return;

        const gsap = window.gsap;
        const ScrollTrigger = window.ScrollTrigger;

        // Kill + reset
        killDesktop();

        // En desktop, el título empieza oculto (hará fade in al final)
        if (centerTitle) gsap.set(centerTitle, { opacity: 0, y: 10 });
        if (centerOverlay) gsap.set(centerOverlay, { opacity: 0 });

        const progressRatio = 0.8;
        const travels = rows.map(measureTravel);
        const maxTravel = Math.max(...travels);
        if (maxTravel < 10) return;

        const effectiveTravel = maxTravel * progressRatio;

        const tl = gsap.timeline({ defaults: { ease: "none" } });

        // Fase A: filas
        rows.forEach((row, idx) => {
          const track = row.querySelector(".wn__track");
          if (!track) return;

          const travel = (travels[idx] || 0) * progressRatio;
          const dir = row.getAttribute("data-dir");

          // Ajustes finos fila 2
          const startOffset = -330;
          const endOffset = -300;

          if (dir === "rtl") {
            gsap.set(track, { x: -travel + startOffset });
            tl.to(track, { x: endOffset }, 0);
          } else {
            gsap.set(track, { x: 0 });
            tl.to(track, { x: -travel }, 0);
          }
        });

        // Fase B: overlay + título
        tl.addLabel("endRows", 1);

        if (centerOverlay) {
          tl.to(centerOverlay, { opacity: 1, duration: 0.35, ease: "power1.out" }, "endRows");
        }
        if (centerTitle) {
          tl.to(centerTitle, { opacity: 1, y: 0, duration: 0.35, ease: "power2.out" }, "endRows+=0.05");
        }

        const factor = 1.1; // desktop fijo
        const extraHoldPx = Math.round(window.innerHeight * 0.65);

        ScrollTrigger.create({
          id: TRIGGER_ID,
          trigger: root,
          start: "top top",
          end: () => "+=" + Math.round(effectiveTravel * factor + extraHoldPx),
          pin: true,
          scrub: true,
          anticipatePin: 1,
          invalidateOnRefresh: true,
          animation: tl,
          refreshPriority: 0,
        });

        queueRefresh();
      }

      // Desktop-only init (espera a media para medir bien)
      function initDesktopWhenReady() {
        const media = Array.from(root.querySelectorAll("img, video"));
        const pending = media.filter((el) => {
          if (el.tagName === "IMG") return !el.complete;
          return el.readyState < 1;
        });

        if (pending.length === 0) {
          buildDesktop();
          return;
        }

        let left = pending.length;
        const done = () => {
          left--;
          if (left <= 0) buildDesktop();
        };

        pending.forEach((el) => {
          if (el.tagName === "IMG") {
            el.addEventListener("load", done, { once: true });
            el.addEventListener("error", done, { once: true });
          } else {
            el.addEventListener("loadedmetadata", done, { once: true });
            el.addEventListener("error", done, { once: true });
          }
        });
      }

      function init() {
        const mq = window.matchMedia(DESKTOP_MQ);

        const apply = () => {
          if (mq.matches) {
            // Desktop: animación + pin
            initDesktopWhenReady();
          } else {
            // Mobile: sin gsap; solo título visible
            killDesktop();
          }
        };

        apply();

        // Si cruzas el breakpoint, reconstruye
        mq.addEventListener?.("change", apply);

        // Resize solo tiene sentido en desktop
        let resizeTimeout;
        window.addEventListener("resize", () => {
          if (!mq.matches) return;
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            buildDesktop();
          }, 200);
        });
      }

      if (document.readyState === "complete") init();
      else window.addEventListener("load", init);
    })();
  </script>
</section>
