---
type Package = {
  id: string;
  name: string;
  description: string;
  standardPrice: number; // euros
  ctaLabel: string;
  badge?: string;
  features: string[];
};

type Props = {
  title: string;
  subtitle: string;
  toggleLeftLabel: string;
  toggleRightLabel: string;
  discountPercent: number;
  locale: string;
  currency: string;
  packages: Package[];
};

const {
  title,
  subtitle,
  toggleLeftLabel,
  toggleRightLabel,
  discountPercent,
  locale,
  currency,
  packages,
} = Astro.props;

const toCents = (eur: number) => Math.round(eur * 100);
---

<section
  class="pk"
  data-discount={discountPercent}
  data-locale={locale}
  data-currency={currency}
>
  <header class="pk__header">
    <h2 class="pk__title">{title}</h2>
    <img class="pk__line" src="public/images/line.svg" alt="" />
    <p class="pk__subtitle">{subtitle}</p>

    <div class="pk__toggleRow">
      <span class="pk__toggleLabel">{toggleLeftLabel}</span>

      <label class="pk__switch">
        <input id="pkToggle" type="checkbox" />
        <span class="pk__slider" aria-hidden="true"></span>
      </label>

      <span class="pk__toggleLabel pk__toggleLabel--muted">{toggleRightLabel}</span>
    </div>
  </header>

  <div class="pk__grid">
    {(packages ?? []).slice(0, 4).map((p) => (
      <article class="pk__card" data-id={p.id}>
        {p.image && (
            <div class="pk__media">
                <img
                class="pk__img"
                src={p.image}
                alt={p.imageAlt ?? ""}
                loading="lazy"
                />
            </div>
            )}
        {p.badge && <div class="pk__badge">{p.badge}</div>}

        <h3 class="pk__name">{p.title}</h3>
        <p class="pk__desc">{p.description}</p>

        <div
            class="pk__price"
            data-standard-cents={toCents(p.standardPrice)}
            >
            <span class="pk__priceNow">€{p.standardPrice}</span>
            <span class="pk__priceWas" aria-hidden="true"></span>
            </div>

        <button class="pk__cta" type="button">{p.ctaLabel}</button>

        {(p.mainFeatures ?? []).length > 0 && (
            <div class="pk__block">
                <div class="pk__blockTitle">MAIN FEATURES</div>
                <ul class="pk__featureList">
                {(p.mainFeatures ?? []).map((f) => (
                    <li class="pk__featureItem">
                    <img class="pk__featureIcon" src={f.icon} alt="" loading="lazy" />
                    <span class="pk__featureText">{f.text}</span>
                    </li>
                ))}
                </ul>
            </div>
            )}

            <div
                class="pk__writing"
                data-writing-min={p.writing.minDays}
                data-writing-max={p.writing.maxDays}
                data-writing-per-day-cents={toCents(p.writing.pricePerDay)}
                >
                <div class="pk__blockTitle">{p.writing.label}</div>

                <div class="pk__stepper">
                    <button class="pk__stepperBtn" type="button" data-action="dec" aria-label="Decrease writing days">−</button>
                    <button class="pk__stepperBtn" type="button" data-action="inc" aria-label="Increase writing days">+</button>

                    <div class="pk__stepperValue">
                    <span class="pk__writingDays">0</span>
                    <span class="pk__writingUnit">{p.writing.unitLabel}</span>
                    </div>
                    
                </div>
            </div>

            {(p.additionalFeatures ?? []).length > 0 && (
            <div class="pk__block">
                <div class="pk__blockTitle">ADDITIONAL FEATURES</div>
                <ul class="pk__featureList">
                {(p.additionalFeatures ?? []).map((f) => (
                    <li class="pk__featureItem">
                    <img class="pk__featureIcon" src={f.icon} alt="" loading="lazy" />
                    <span class="pk__featureText">{f.text}</span>
                    </li>
                ))}
                </ul>
            </div>
            )}

            {p.requirements && (
            <div class="pk__block">
                <div class="pk__blockTitle">REQUIREMENTS</div>
                <p class="pk__requirements">{p.requirements}</p>
            </div>
            )}

      </article>
    ))}
  </div>

    <script is:inline>
    (function () {
        const root = document.currentScript?.closest(".pk");
        if (!root) return;

        const discountPercent = Number(root.getAttribute("data-discount") || "0");
        const locale = root.getAttribute("data-locale") || "en-GB";
        const currency = root.getAttribute("data-currency") || "EUR";

        const toggle = root.querySelector("#pkToggle");
        const cards = root.querySelectorAll(".pk__card");

        const fmt = new Intl.NumberFormat(locale, {
        style: "currency",
        currency,
        maximumFractionDigits: 0,
        });

        function priceFromCents(cents) {
        return cents / 100;
        }

        function calcCardPriceCents(card, discounted) {
        const base = Number(card.querySelector(".pk__price")?.getAttribute("data-standard-cents") || "0");

        const writingWrap = card.querySelector(".pk__writing");
        const perDay = Number(writingWrap?.getAttribute("data-writing-per-day-cents") || "0");
        const days = Number(card.getAttribute("data-writing-days") || "0");

        const subtotal = base + days * perDay;
        return discounted ? Math.round(subtotal * (1 - discountPercent / 100)) : subtotal;
        }

        function renderPrices() {
        const discounted = !!toggle?.checked;
        
        cards.forEach((card) => {
            const priceWrap = card.querySelector(".pk__price");
            if (!priceWrap) return;

            const nowEl = priceWrap.querySelector(".pk__priceNow");
            const wasEl = priceWrap.querySelector(".pk__priceWas");
            if (!nowEl || !wasEl) return;

            const discounted = !!toggle?.checked;

            // precio "antes" = base + writing (sin descuento)
            const wasCents = calcCardPriceCents(card, false);
            // precio "ahora" = con o sin descuento
            const nowCents = calcCardPriceCents(card, discounted);

            nowEl.textContent = fmt.format(priceFromCents(nowCents));

            if (discounted) {
                wasEl.textContent = fmt.format(priceFromCents(wasCents));
                wasEl.style.display = "inline";
            } else {
                wasEl.textContent = "";
                wasEl.style.display = "none";
            }
            });

        root.setAttribute("data-mode", discounted ? "discount" : "standard");
        }

        // init toggle state (persist)
        const saved = localStorage.getItem("pk_discounted");
        const initialDiscount = saved === "1";
        if (toggle) toggle.checked = initialDiscount;

        // init cards steppers
        cards.forEach((card) => {
        card.setAttribute("data-writing-days", "0");

        const writingWrap = card.querySelector(".pk__writing");
        const valueEl = card.querySelector(".pk__writingDays");
        if (!writingWrap || !valueEl) return;

        const min = Number(writingWrap.getAttribute("data-writing-min") || "0");
        const max = Number(writingWrap.getAttribute("data-writing-max") || "3");

        function setDays(next) {
            const clamped = Math.max(min, Math.min(max, next));
            card.setAttribute("data-writing-days", String(clamped));
            valueEl.textContent = String(clamped);
            renderPrices();
        }

        card.querySelectorAll("[data-action]").forEach((btn) => {
            btn.addEventListener("click", () => {
            const current = Number(card.getAttribute("data-writing-days") || "0");
            const action = btn.getAttribute("data-action");
            setDays(action === "inc" ? current + 1 : current - 1);
            });
        });

        // start at min (normalmente 0)
        setDays(min);
        });

        // initial render
        renderPrices();

        toggle?.addEventListener("change", () => {
        const on = !!toggle.checked;
        localStorage.setItem("pk_discounted", on ? "1" : "0");
        renderPrices();
        });
    })();
    </script>

  <style>
    /* Solo base mínima para que no se rompa */
    .pk__subtitle { white-space: pre-line; }

    .pk__switch { display:inline-flex; align-items:center; }
    .pk__switch input{ position:absolute; opacity:0; pointer-events:none; }
    .pk__slider{
      cursor: pointer;width:6.7rem; height:4rem; border:2px solid #111; border-radius:999px; position:relative; display:block;
    }
    .pk__slider::after{
      content:""; width: 3.3rem;
    height: 3.3rem;
     border-radius:999px; background: #111; position:absolute; top:50%; left:4px;
      transform:translateY(-50%); transition:transform .2s ease;
    }
    .pk__switch input:checked + .pk__slider::after{
      transform: translate(26px, -50%);
    }
  </style>
</section>
