---
type Feature = { icon: string; text: string; tooltip?: string };

type WritingConfig = {
  enabled?: boolean;
  label: string;
  unitLabel: string;
  minDays: number;
  maxDays: number;
  pricePerDay: number;
};

type Package = {
  id: string;
  title: string;
  description: string;
  video: string;
  poster?: string;
  videoLabel?: string;
  standardPrice: number;
  ctaLabel: string;
  badge?: string;
  mainFeatures?: Feature[];
  writing: WritingConfig;
  additionalFeatures?: Feature[];
  requirements?: Feature;
  footerText?: string;
};

type Props = {
  title: string;
  subtitle: string;
  modalSubtitle: string;
  toggleLeftLabel: string;
  toggleRightLabel: string;
  discountPercent: number;
  locale: string;
  currency: string;
  packages: Package[];
};

const {
  title,
  subtitle,
  toggleLeftLabel,
  toggleRightLabel,
  discountPercent,
  locale,
  currency,
  packages,
  modalSubtitle,
} = Astro.props;

const toCents = (eur: number) => Math.round(eur * 100);
---

<section
  id="packages"
  class="pk"
  data-discount={discountPercent}
  data-locale={locale}
  data-currency={currency}
  data-modal-subtitle={modalSubtitle}
>
  <header class="pk__header">
    <h2 class="pk__title">{title}</h2>
    <img class="pk__line" src="/images/line.svg" alt="" />
    <p class="pk__subtitle">{subtitle}</p>

    <div class="pk__toggleRow">
      <span class="pk__toggleLabel" data-side="left">{toggleLeftLabel}</span>

      <label class="pk__switch">
        <input id="pkToggle" type="checkbox" />
        <span class="pk__slider" aria-hidden="true"></span>
      </label>

      <span class="pk__toggleLabel pk__toggleLabel--muted" data-side="right">{toggleRightLabel}</span>
    </div>

    <div class="pk__discountInfo" hidden>
      In exchange for the discount, the client agrees for Boldmove to use a dummy text version of the deck for promotional purposes (including on the website) as soon as the project is complete.
    </div>
  </header>

  <div class="pk__grid">
    {(packages ?? []).slice(0, 4).map((p) => (
      <article class="pk__card" data-id={p.id}>
        <div class="pk__discountBadge" hidden></div>

        {p.video && (
          <div class="pk__media">
            <video
              class="pk__video"
              src={p.video}
              poster={p.poster || undefined}
              muted
              loop
              playsinline
              preload="metadata"
              aria-label={p.videoLabel ?? p.title}
            />
          </div>
        )}

        {p.badge && p.badge.trim() !== "" && <div class="pk__badge">{p.badge}</div>}

        <h3 class="pk__name">{p.title}</h3>
        <p class="pk__desc">{p.description}</p>

        <div class="pk__price" data-standard-cents={toCents(p.standardPrice)}>
          <span class="pk__priceNow">€{p.standardPrice}</span>
          <span class="pk__priceWas" aria-hidden="true"></span>
        </div>

        <button
          class="pk__cta"
          type="button"
          data-open-package
          data-package-id={p.id}
          data-package-title={p.title}
          data-cta={p.ctaLabel}
        >
          {p.ctaLabel}
        </button>

        {(p.mainFeatures ?? []).length > 0 && (
          <div class="pk__block">
            <div class="pk__blockTitle">MAIN FEATURES</div>
            <ul class="pk__featureList">
              {(p.mainFeatures ?? []).map((f) => (
                <li
                  class="pk__featureItem"
                  tabindex={f.tooltip && f.tooltip.trim() !== "" ? "0" : undefined}
                >
                  <img class="pk__featureIcon" src={f.icon} alt="" loading="lazy" />
                  <span class="pk__featureText">{f.text}</span>

                  {f.tooltip && f.tooltip.trim() !== "" && (
                    <span class="pk__tipBubble" role="tooltip">
                      {f.tooltip}
                    </span>
                  )}
                </li>

              ))}
            </ul>
          </div>
        )}

        {p.writing && (
          <div
            class="pk__writing"
            data-writing-min={p.writing.minDays}
            data-writing-max={p.writing.maxDays}
            data-writing-per-day-cents={toCents(p.writing.pricePerDay)}
          >
            <div class="pk__blockTitle">{p.writing.label}</div>

            <div class="pk__stepper">
              <button class="pk__stepperBtn" type="button" data-action="dec" aria-label="Decrease writing days">
                −
              </button>
              <button class="pk__stepperBtn" type="button" data-action="inc" aria-label="Increase writing days">
                +
              </button>

              <div
                class="pk__stepperValue pk__stepperValue--hasTip"
                tabindex="0"
                data-tip={p.writing.tooltip || ""}
                aria-label={p.writing.tooltip || ""}
              >
                <span class="pk__writingDays">0</span>
                <span class="pk__writingUnit">{p.writing.unitLabel}</span>
              </div>

            </div>
          </div>
        )}

        {(p.additionalFeatures ?? []).length > 0 && (
          <div class="pk__block">
            <div class="pk__blockTitle">ADDITIONAL FEATURES</div>
            <ul class="pk__featureList">
              {(p.additionalFeatures ?? []).map((f) => (
                <li
                  class="pk__featureItem"
                  tabindex={f.tooltip && f.tooltip.trim() !== "" ? "0" : undefined}
                >
                  <img class="pk__featureIcon" src={f.icon} alt="" loading="lazy" />
                  <span class="pk__featureText">{f.text}</span>

                  {f.tooltip && f.tooltip.trim() !== "" && (
                    <span class="pk__tipBubble" role="tooltip">
                      {f.tooltip}
                    </span>
                  )}
                </li>

              ))}
            </ul>
          </div>
        )}

        {p.requirements?.text && p.requirements.text.trim() !== "" && (
          <div class="pk__block">
            <div class="pk__blockTitle">REQUIREMENTS</div>
            <div class="pk__requirementsRow">
              {p.requirements.icon && (
                <img class="pk__featureIcon" src={p.requirements.icon} alt="" loading="lazy" />
              )}
              <p class="pk__requirements">{p.requirements.text}</p>
            </div>
          </div>
        )}

        {p.footerText && p.footerText.trim() !== "" && (
          <div class="pk__footer">{p.footerText}</div>
        )}
      </article>
    ))}
  </div>

  <div class="pkModal" hidden aria-hidden="true">
    <div class="pkModal__overlay" data-close-modal></div>

    <div class="pkModal__panel" role="dialog" aria-modal="true" aria-labelledby="pkModalTitle">
      <button class="pkModal__close" type="button" data-close-modal aria-label="Close">×</button>

      <h3 class="pkModal__title" id="pkModalTitle">YOU HAVE SELECTED THE <span class="pkModal__titleName"></span> PACKAGE</h3>
      <p class="pkModal__subtitle" data-modal-subtitle={modalSubtitle}>{modalSubtitle}</p>

      <form
        class="pkModal__form"
        name="package-enquiry"
        method="POST"
        action="/thanks/"
        data-netlify="true"
        netlify-honeypot="bot-field"
      >
        <input type="hidden" name="form-name" value="package-enquiry" />
        <p hidden>
          <label>Don't fill this out: <input name="bot-field" /></label>
        </p>

        <input class="pkModal__input" type="text" name="name" placeholder="Name" required />
        <input class="pkModal__input" type="email" name="email" placeholder="Email" required />
        <textarea class="pkModal__input pkModal__textarea" name="message" placeholder="Message (Optional)" rows="1"></textarea>

        <input type="hidden" name="package_title" />
        <input type="hidden" name="package_price" />
        <input type="hidden" name="discounted" />
        <input type="hidden" name="writing_days" />

        <button class="pkModal__submit" type="submit">Send</button>
      </form>
    </div>
  </div>

  <script is:inline>
  (function () {
    const root = document.currentScript?.closest(".pk");
    if (!root) return;

    const discountPercent = Number(root.getAttribute("data-discount") || "0");
    const locale = root.getAttribute("data-locale") || "en-GB";
    const currency = root.getAttribute("data-currency") || "EUR";

    const toggle = root.querySelector("#pkToggle");
    const cards = root.querySelectorAll(".pk__card");
    const modal = root.querySelector(".pkModal");
    const modalTitle = root.querySelector(".pkModal__title");
    const modalSubtitle = root.querySelector(".pkModal__subtitle");
    const form = root.querySelector(".pkModal__form");

    const fmt = new Intl.NumberFormat(locale, {
      style: "currency",
      currency,
      maximumFractionDigits: 0,
    });

    const priceFromCents = (cents) => cents / 100;

    function calcCardPriceCents(card, discounted) {
      const base = Number(card.querySelector(".pk__price")?.getAttribute("data-standard-cents") || "0");
      const writingWrap = card.querySelector(".pk__writing");
      const perDay = Number(writingWrap?.getAttribute("data-writing-per-day-cents") || "0");
      const days = Number(card.getAttribute("data-writing-days") || "0");
      const subtotal = base + days * perDay;
      return discounted ? Math.round(subtotal * (1 - discountPercent / 100)) : subtotal;
    }

    function renderPrices() {
      const discounted = !!toggle?.checked;

      cards.forEach((card) => {
        const priceWrap = card.querySelector(".pk__price");
        const nowEl = priceWrap?.querySelector(".pk__priceNow");
        const wasEl = priceWrap?.querySelector(".pk__priceWas");
        if (!nowEl || !wasEl) return;

        const wasCents = calcCardPriceCents(card, false);
        const nowCents = calcCardPriceCents(card, discounted);

        nowEl.textContent = fmt.format(priceFromCents(nowCents));
        wasEl.textContent = discounted ? fmt.format(priceFromCents(wasCents)) : "";
        wasEl.style.display = discounted ? "inline" : "none";

        const badge = card.querySelector(".pk__discountBadge");
        if (badge) {
          badge.hidden = !discounted;
          if (discounted) badge.textContent = `${discountPercent}% off`;
        }
      });

      root.setAttribute("data-mode", discounted ? "discount" : "standard");

      const info = root.querySelector(".pk__discountInfo");
      if (info) info.hidden = !discounted;

      const labelLeft = root.querySelector(".pk__toggleLabel[data-side='left']");
      const labelRight = root.querySelector(".pk__toggleLabel[data-side='right']");
      if (labelLeft && labelRight) {
        labelLeft.classList.toggle("pk__toggleLabel--dim", discounted);
        labelRight.classList.toggle("pk__toggleLabel--dim", !discounted);
      }
    }

    // ── Steppers ──────────────────────────────────────────────
    const DEFAULT_STEPS = [0, 0.5, 1, 2];

    function parseSteps(writingWrap) {
      const raw = writingWrap?.getAttribute("data-writing-steps");
      if (!raw) return DEFAULT_STEPS;
      const steps = raw.split(",").map((s) => Number(String(s).trim())).filter((n) => Number.isFinite(n)).sort((a, b) => a - b);
      return steps.length ? steps : DEFAULT_STEPS;
    }

    function clampToSteps(val, steps) {
      let best = steps[0];
      let bestDist = Math.abs(val - best);
      for (let i = 1; i < steps.length; i++) {
        const d = Math.abs(val - steps[i]);
        if (d < bestDist) { best = steps[i]; bestDist = d; }
      }
      return best;
    }

    function formatDays(n) {
      return Number.isInteger(n) ? String(n) : String(n);
    }

    cards.forEach((card) => {
      card.setAttribute("data-writing-days", "0");

      const writingWrap = card.querySelector(".pk__writing");
      const valueEl = card.querySelector(".pk__writingDays");
      if (!writingWrap || !valueEl) return;

      const min = Number(writingWrap.getAttribute("data-writing-min") || "0");
      const max = Number(writingWrap.getAttribute("data-writing-max") || "3");
      const stepsAll = parseSteps(writingWrap);
      const steps = stepsAll.filter((s) => s >= min && s <= max);
      const safeSteps = steps.length ? steps : DEFAULT_STEPS.filter((s) => s >= min && s <= max);

      function setDays(next) {
        const snapped = clampToSteps(next, safeSteps);
        card.setAttribute("data-writing-days", String(snapped));
        valueEl.textContent = formatDays(snapped);
        renderPrices();
      }

      function getCurrent() {
        return clampToSteps(Number(card.getAttribute("data-writing-days") || "0"), safeSteps);
      }

      function step(action) {
        const current = getCurrent();
        const idx = safeSteps.indexOf(current);
        const nextIdx = action === "inc" ? idx + 1 : idx - 1;
        setDays(safeSteps[Math.max(0, Math.min(safeSteps.length - 1, nextIdx))]);
      }

      card.querySelectorAll("[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => step(btn.getAttribute("data-action")));
      });

      setDays(min);
    });

    // ── Mostrar primer frame en todos los videos ───────────────
    // Funciona en desktop y móvil. Fuerza el primer frame visible
    // sin reproducir el vídeo.
    function showFirstFrame(video) {
      // Si ya tiene poster, el navegador lo usará — no hacemos nada
      if (video.poster) return;

      const trySeek = () => {
        // readyState >= 1 significa que los metadatos están listos
        if (video.readyState >= 1) {
          video.currentTime = 0.001;
        } else {
          video.addEventListener("loadedmetadata", () => {
            video.currentTime = 0.001;
          }, { once: true });
        }
      };

      trySeek();
    }

    root.querySelectorAll(".pk__video").forEach(showFirstFrame);

    // ── Video hover (desktop only) ─────────────────────────────
    const canHover = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

    if (canHover) {
      cards.forEach((card) => {
        const video = card.querySelector(".pk__video");
        if (!video) return;

        card.addEventListener("mouseenter", () => {
          video.play().catch(() => {});
        });

        card.addEventListener("mouseleave", () => {
          video.pause();
          // Volvemos al primer frame al salir del hover
          video.currentTime = 0.001;
        });
      });
    }

    // ── Toggle ────────────────────────────────────────────────
    const saved = localStorage.getItem("pk_discounted");
    if (toggle) toggle.checked = saved === "1";

    renderPrices();

    toggle?.addEventListener("change", () => {
      localStorage.setItem("pk_discounted", toggle.checked ? "1" : "0");
      renderPrices();
    });

    // ── Modal ─────────────────────────────────────────────────
    function setHidden(name, value) {
      const el = form?.querySelector(`input[name="${name}"]`);
      if (el) el.value = value ?? "";
    }

    function openModal(card, { packageId, packageTitle }) {
      if (!modal || !form) return;

      const discounted = !!toggle?.checked;
      const nowCents = calcCardPriceCents(card, discounted);

      const nameEl = modalTitle?.querySelector(".pkModal__titleName");
      if (nameEl) nameEl.textContent = packageTitle.toUpperCase();
      if (modalSubtitle) modalSubtitle.textContent = root.getAttribute("data-modal-subtitle") || "";

      setHidden("package_id", packageId);
      setHidden("package_title", packageTitle);
      setHidden("package_price", fmt.format(priceFromCents(nowCents)));
      setHidden("discounted", discounted ? "1" : "0");
      setHidden("writing_days", card.getAttribute("data-writing-days") || "0");

      cards.forEach((c) => c.querySelector(".pk__video")?.pause());

      modal.hidden = false;
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      form.querySelector('input[name="name"]')?.focus();
    }

    function closeModal() {
      if (!modal) return;
      modal.hidden = true;
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      cards.forEach((c) => {
        const v = c.querySelector(".pk__video");
        if (v) {
          v.pause();
          // Restaurar primer frame al cerrar modal
          v.currentTime = 0.001;
        }
      });
    }

    root.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-open-package]");
      if (!btn) return;
      const card = btn.closest(".pk__card");
      if (!card) return;
      openModal(card, {
        packageId: btn.getAttribute("data-package-id"),
        packageTitle: btn.getAttribute("data-package-title"),
      });
    });

    modal?.addEventListener("click", (e) => {
      if (e.target.closest("[data-close-modal]")) closeModal();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal && !modal.hidden) closeModal();
    });

    // ── External open (UpgradeSection, etc.) ───────────────────
    window.addEventListener("open-package-modal", (e) => {
      const detail = e.detail || {};
      if (!detail.packageId || !detail.packageTitle) return;

      const priceNumber = Number(detail.packagePrice || 0);
      const cents = Math.round(priceNumber * 100);

      const nameEl = modalTitle?.querySelector(".pkModal__titleName");
      if (nameEl) nameEl.textContent = String(detail.packageTitle).toUpperCase();
      if (modalSubtitle) modalSubtitle.textContent = root.getAttribute("data-modal-subtitle") || "";

      setHidden("package_id", String(detail.packageId));
      setHidden("package_title", String(detail.packageTitle));
      setHidden("package_price", fmt.format(priceFromCents(cents)));
      setHidden("discounted", "0");
      setHidden("writing_days", "0");

      modal.hidden = false;
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      form?.querySelector('input[name="name"]')?.focus();
    });

  })();
  </script>

  <style>
    .pk__media { border-radius: 28px; overflow: hidden; }
    .pk__video { width: 100%; height: 100%; display: block; object-fit: cover; }
    .pk__subtitle { white-space: pre-line; }

    .pk__switch { display:inline-flex; align-items:center; }
    .pk__switch input{ position:absolute; opacity:0; pointer-events:none; }
    .pk__slider{
      cursor: pointer; width:6.7rem; height:4rem; border:2px solid #111; border-radius:999px; position:relative; display:block;
    }
    .pk__slider::after{
      content:""; width: 3.3rem; height: 3.3rem; border-radius:999px; background: #111; position:absolute; top:50%; left:4px;
      transform:translateY(-50%); transition:transform .2s ease;
    }
    .pk__switch input:checked + .pk__slider::after{
      transform: translate(26px, -50%);
    }
  </style>
</section>