---
type Feature = {
  icon: string;
  text: string;
};

type UpgradeCard = {
  id: string;
  title: string;
  description: string;
  video: string;
  poster?: string;
  videoLabel?: string;
  standardPrice: number;
  ctaLabel: string;
  badge?: string;
  mainFeatures?: Feature[];
  additionalFeatures?: Feature[];
  requirements?: Feature;
};

type Props = {
  title: string;
  card: UpgradeCard;
  locale?: string;
  currency?: string;
};

const { title, card, footerText, locale = "en-GB", currency = "EUR" } = Astro.props;

const fmt = new Intl.NumberFormat(locale, {
  style: "currency",
  currency,
  maximumFractionDigits: 0,
});
---

<section class="up">
  <h2 class="up__title">{title}</h2>
  <div class="up__card" data-id={card.id}>
    <div class="up__media">
    {card.video && (
      <video
        class="up__video"
        src={card.video}
        poster={card.poster}
        muted
        
        loop
        playsinline
        preload="metadata"
        aria-label={card.videoLabel ?? card.title}
      />
    )}
  </div>

    <div class="up__main">
      {card.badge && <div class="up__badge">{card.badge}</div>}

      <h3 class="up__name">{card.title}</h3>
      <p class="up__desc">{card.description}</p>

      <div class="up__price">{fmt.format(card.standardPrice)}</div>

      <button
        class="up__cta"
        type="button"
        data-open-package
        data-package-id={card.id}
        data-package-title={card.title}
        data-package-price={String(card.standardPrice)}
      >
        {card.ctaLabel}
</button>

    </div>

    <div class="up__features">
      <div class="up__block">
        <div class="up__blockTitle">MAIN FEATURES</div>

        {(card.mainFeatures ?? []).length > 0 ? (
          <ul class="up__list">
            {(card.mainFeatures ?? []).map((f) => (
              <li class="up__item">
                <img class="up__icon" src={f.icon} alt="" loading="lazy" />
                <span class="up__text">{f.text}</span>
              </li>
            ))}
          </ul>
        ) : (
          <p class="up__empty">—</p>
        )}
      </div>
      <div class="up__block">
        <div class="up__blockTitle">ADDITIONAL FEATURES</div>

        {(card.additionalFeatures ?? []).length > 0 ? (
          <ul class="up__list">
            {(card.additionalFeatures ?? []).map((f) => (
              <li class="up__item">
                <img class="up__icon" src={f.icon} alt="" loading="lazy" />
                <span class="up__text">{f.text}</span>
              </li>
            ))}
          </ul>
        ) : (
          <p class="up__empty">—</p>
        )}
      </div>

      {card.requirements?.text && card.requirements.text.trim() !== "" && (
        <div class="up__block">
          <div class="up__blockTitle">REQUIREMENTS</div>

          <div class="up__reqRow">
            {card.requirements.icon && (
              <img class="up__icon" src={card.requirements.icon} alt="" loading="lazy" />
            )}
            <p class="up__req">{card.requirements.text}</p>
          </div>
        </div>
      )}
    </div>

  </div>
{footerText && (
  <div class="up__footer">
    <p class="up__footertext">{footerText}</p>
    <a href="#contact" class="pk__cta" type="button">Give us a shout out</a>
  </div>
)}

  <script is:inline>
  (function () {
    const root = document.currentScript?.closest(".up");
    if (!root) return;

    root.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-open-package]");
      if (!btn) return;

      window.dispatchEvent(
        new CustomEvent("open-package-modal", {
          detail: {
            packageId: btn.getAttribute("data-package-id"),
            packageTitle: btn.getAttribute("data-package-title"),
            packagePrice: btn.getAttribute("data-package-price"),
          },
        })
      );
    });

    // ── Video hover (desktop only) ─────────────────────────────
  const canHover = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

  if (canHover) {
    const card = root.querySelector(".up__card");
      const video = card.querySelector(".up__video");
      if (!video) return;

      // Hover sobre la card completa (si prefieres solo media: usa card.querySelector(".up__media"))
      card.addEventListener("mouseenter", () => {
        // si el vídeo no está listo aún, play() puede fallar: ignoramos
        video.play().catch(() => {});
      });

      card.addEventListener("mouseleave", () => {
        video.pause();
        video.currentTime = 0; // ← quita esta línea si quieres que continúe donde iba
      });
  }
  })();
</script>

</section>
