---
type PlatformVideo = {
  label: string;
  src?: string;
  url?: string;
  link?: string;
  poster?: string;
  muted?: boolean;
  autoplay?: boolean;
  loop?: boolean;
  controls?: boolean;
};

type Props = {
  title: string;
  body: { p1: string; p2: string; emphasis: string };
  videos: PlatformVideo[];
};

const { title, body = { p1: "", p2: "", emphasis: "" }, videos = [] } = Astro.props;

const getVideoSrc = (v: PlatformVideo) => (v.src && v.src.trim() ? v.src : (v.url || "").trim());
---

<section id="platforms" class="plt">
  <div class="plt__top">
    <h2 class="plt__title">{title}</h2>

    <div class="plt__copy">
      <p class="plt__p">{body.p1}</p>
      <p class="plt__p">{body.p2}</p>
      <p class="plt__em">{body.emphasis}</p>
    </div>
  </div>

  <div class="plt__videos">
    {videos.slice(0, 2).map((v, i) => {
      const src = getVideoSrc(v);
      const link = v.link?.trim() || "";
      const hasLink = !!link;

      return (
        <div class="plt__videoCol" data-i={i}>
          <div class="plt__videoLabel">{v.label}</div>

          <div class="plt__videoFrame">
            {src ? (
              <div class="plt__videoWrap">
                <video
                  class="plt__video"
                  src={src}
                  poster={v.poster || undefined}
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  data-link={hasLink ? link : undefined}
                />
                {/* Botón de play — visible en móvil, oculto en desktop */}
                <button class="plt__playBtn" type="button" aria-label="Play video">
                  <svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="30" cy="30" r="29" stroke="#f6f4e5" stroke-width="2" fill="rgba(0,0,0,0.4)"/>
                    <polygon points="22,18 44,30 22,42" fill="#f6f4e5"/>
                  </svg>
                </button>
              </div>
            ) : (
              <div class="plt__videoPlaceholder">
                Add a video in Decap (mp4/webm) or paste a URL.
              </div>
            )}
          </div>
        </div>
      );
    })}
  </div>

  <script is:inline>
  (function () {
    const root = document.currentScript?.closest(".plt");
    if (!root) return;

    const isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

    const showFirstFrame = (video) => {
      const seek = () => { video.currentTime = 0.001; };
      if (video.readyState >= 1) seek();
      else video.addEventListener("loadedmetadata", seek, { once: true });
    };

    root.querySelectorAll(".plt__videoWrap").forEach((wrap) => {
      const video = wrap.querySelector(".plt__video");
      const playBtn = wrap.querySelector(".plt__playBtn");
      if (!video) return;

      const link = video.getAttribute("data-link");

      // Mostrar primer frame si no hay poster
      if (!video.poster) showFirstFrame(video);

      if (isDesktop) {
        // Desktop: hover reproduce, click abre link
        if (link) {
          video.style.cursor = "pointer";
          video.addEventListener("click", (e) => {
            e.preventDefault();
            window.open(link, "_blank", "noopener,noreferrer");
          });
        }

        video.addEventListener("mouseenter", () => video.play().catch(() => {}));
        video.addEventListener("mouseleave", () => {
          video.pause();
          video.currentTime = 0.001;
        });

      } else {
        // Móvil: botón de play → reproduce
        // Tap en video mientras reproduce → abre link externo
        if (playBtn) {
          const startPlay = () => {
            video.play().catch(() => {});
            playBtn.classList.add("plt__playBtn--hidden");

            video.addEventListener("ended", () => {
              playBtn.classList.remove("plt__playBtn--hidden");
              if (!video.poster) showFirstFrame(video);
            }, { once: true });
          };

          playBtn.addEventListener("click", startPlay);

          video.addEventListener("click", () => {
            if (!video.paused) {
              // Reproduciendo → abrir link
              if (link) window.open(link, "_blank", "noopener,noreferrer");
            } else {
              // Pausado → reproducir
              startPlay();
            }
          });
        }
      }
    });
  })();
  </script>

  <style>
    .plt__videoWrap {
      position: relative;
      display: block;
    }

    .plt__video {
      width: 100%;
      display: block;
    }

    .plt__playBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: opacity 0.2s ease;
      z-index: 2;
    }

    .plt__playBtn svg {
      width: 100%;
      height: 100%;
    }

    .plt__playBtn--hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Desktop: ocultar botón de play siempre */
    @media (hover: hover) and (pointer: fine) {
      .plt__playBtn {
        display: none;
      }
    }
  </style>
</section>