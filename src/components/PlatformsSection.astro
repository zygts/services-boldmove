---
type PlatformVideo = {
  label: string;
  src?: string;
  url?: string;
  link?: string;
  poster?: string;
  muted?: boolean;
  autoplay?: boolean;
  loop?: boolean;
  controls?: boolean;
};

type Props = {
  title: string;
  body: { p1: string; p2: string; emphasis: string };
  videos: PlatformVideo[];
};

const { title, body = { p1: "", p2: "", emphasis: "" }, videos = [] } = Astro.props;

const getVideoSrc = (v: PlatformVideo) => (v.src && v.src.trim() ? v.src : (v.url || "").trim());
---

<section id="platforms" class="plt">
  <div class="plt__top">
    <h2 class="plt__title">{title}</h2>

    <div class="plt__copy">
      <p class="plt__p">{body.p1}</p>
      <p class="plt__p">{body.p2}</p>
      <p class="plt__em">{body.emphasis}</p>
    </div>
  </div>

  <div class="plt__videos">
    {videos.slice(0, 2).map((v, i) => {
      const src = getVideoSrc(v);
      const link = v.link?.trim() || "#";
      const hasLink = link && link !== "#";

      return (
        <div class="plt__videoCol" data-i={i}>
          <div class="plt__videoLabel">{v.label}</div>

          <div class="plt__videoFrame">
            {src ? (
              <>
                {/* Desktop: video con hover */}
                <video
                  class="plt__video plt__desktop"
                  src={src}
                  poster={v.poster || undefined}
                  muted
                  loop
                  playsinline
                  preload="metadata"
                  data-link={hasLink ? link : undefined}
                />

                {/* Mobile: solo imagen estática */}
                {v.poster ? (
                  <img
                    class="plt__poster plt__mobile"
                    src={v.poster}
                    alt={v.label ?? ""}
                    loading="lazy"
                  />
                ) : (
                  // Si no hay poster, mostramos el video igual (sin autoplay)
                  <video
                    class="plt__video plt__mobile"
                    src={src}
                    muted
                    playsinline
                    preload="metadata"
                    data-link={hasLink ? link : undefined}
                  />
                )}
              </>
            ) : (
              <div class="plt__videoPlaceholder">
                Add a video in Decap (mp4/webm) or paste a URL.
              </div>
            )}
          </div>
        </div>
      );
    })}
  </div>

  <script is:inline>
  (function () {
    const root = document.currentScript?.closest(".plt");
    if (!root) return;

    const isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

    if (!isDesktop) {
      // Móvil: forzar primer frame en videos mobile (los sin poster)
      root.querySelectorAll(".plt__mobile video").forEach((video) => {
        const seek = () => { video.currentTime = 0.001; };
        if (video.readyState >= 1) seek();
        else video.addEventListener("loadedmetadata", seek, { once: true });
      });
      return;
    }

    // Desktop: comportamiento hover en los videos desktop
    root.querySelectorAll(".plt__video.plt__desktop").forEach((video) => {
      const link = video.getAttribute("data-link");

      if (link) {
        video.style.cursor = "pointer";
        video.addEventListener("click", (e) => {
          e.preventDefault();
          window.open(link, "_blank", "noopener,noreferrer");
        });
      }

      // Mostrar primer frame en reposo
      const seek = () => { video.currentTime = 0.001; };
      if (video.readyState >= 1) seek();
      else video.addEventListener("loadedmetadata", seek, { once: true });

      video.addEventListener("mouseenter", () => {
        video.play().catch(() => {});
      });

      video.addEventListener("mouseleave", () => {
        video.pause();
        video.currentTime = 0.001;
      });
    });
  })();
  </script>

  <style>
   
  </style>
</section>