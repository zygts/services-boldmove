---
type PlatformVideo = {
  label: string;
  src?: string;
  url?: string;
  link?: string;
  poster?: string;
  muted?: boolean;
  autoplay?: boolean;
  loop?: boolean;
  controls?: boolean;
};

type Props = {
  title: string;
  body: { p1: string; p2: string; emphasis: string };
  videos: PlatformVideo[];
};

const { title, body, videos = [] } = Astro.props;

const getVideoSrc = (v: PlatformVideo) => (v.src && v.src.trim() ? v.src : (v.url || "").trim());

// ðŸ‘‡ DEBUG: Ver quÃ© datos llegan
console.log('Platform videos:', JSON.stringify(videos, null, 2));
---

<section id="platforms" class="plt">
  <div class="plt__top">
    <h2 class="plt__title">{title}</h2>

    <div class="plt__copy">
      <p class="plt__p">{body.p1}</p>
      <p class="plt__p">{body.p2}</p>
      <p class="plt__em">{body.emphasis}</p>
    </div>
  </div>

  <div class="plt__videos">
    {videos.slice(0, 2).map((v, i) => {
      const src = getVideoSrc(v);
      const link = v.link?.trim();
      const hasLink = link && link !== "#" && link !== "";
      
      // ðŸ‘‡ DEBUG: Ver valores por video
      console.log(`Video ${i}:`, { 
        label: v.label, 
        link: v.link, 
        linkTrimmed: link, 
        hasLink 
      });
      
      return (
        <div class="plt__videoCol" data-i={i}>
          <div class="plt__videoLabel">{v.label}</div>

          {/* ðŸ‘‡ DEBUG: Mostrar visualmente si tiene link */}
          <div style="background: yellow; padding: 4px; font-size: 10px;">
            DEBUG: hasLink={String(hasLink)} | link="{link}"
          </div>

          {hasLink ? (
            <a 
              href={link} 
              target="_blank" 
              rel="noopener noreferrer"
              class="plt__videoFrame plt__videoFrame--link"
              aria-label={`Open ${v.label} in new tab`}
            >
              {src ? (
                <video
                  class="plt__video"
                  src={src}
                  poster={v.poster || undefined}
                  muted
                  loop
                  playsinline
                  preload="metadata"
                />
              ) : (
                <div class="plt__videoPlaceholder">
                  Add a video in Decap (mp4/webm) or paste a URL.
                </div>
              )}
            </a>
          ) : (
            <div class="plt__videoFrame">
              {src ? (
                <video
                  class="plt__video"
                  src={src}
                  poster={v.poster || undefined}
                  muted
                  loop
                  playsinline
                  preload="metadata"
                />
              ) : (
                <div class="plt__videoPlaceholder">
                  Add a video in Decap (mp4/webm) or paste a URL.
                </div>
              )}
            </div>
          )}
        </div>
      );
    })}
  </div>

  <script is:inline>
  (function () {
    const root = document.currentScript?.closest(".plt");
    if (!root) return;

    const videos = root.querySelectorAll(".plt__video");

    const isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)").matches;
    if (!isDesktop) return;

    videos.forEach((video) => {
      video.addEventListener("mouseenter", () => {
        video.play().catch(() => {});
      });

      video.addEventListener("mouseleave", () => {
        video.pause();
        video.currentTime = 0;
      });
    });
  })();
  </script>

  <style>
    .plt__videoFrame {
      display: block;
    }

    .plt__videoFrame--link {
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
  </style>
</section>