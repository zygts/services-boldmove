---
type PlatformVideo = {
  label: string;
  src?: string;
  url?: string;
  link?: string;
  poster?: string;
  muted?: boolean;
  autoplay?: boolean;
  loop?: boolean;
  controls?: boolean;
};

type Props = {
  title: string;
  body: { p1: string; p2: string; emphasis: string };
  videos: PlatformVideo[];
};

const { title, body = { p1: "", p2: "", emphasis: "" }, videos = [] } = Astro.props;

const getVideoSrc = (v: PlatformVideo) => (v.src && v.src.trim() ? v.src : (v.url || "").trim());
---

<section id="platforms" class="plt">
  <div class="plt__top">
    <h2 class="plt__title">{title}</h2>

    <div class="plt__copy">
      <p class="plt__p">{body.p1}</p>
      <p class="plt__p">{body.p2}</p>
      <p class="plt__em">{body.emphasis}</p>
    </div>
  </div>

  <div class="plt__videos">
    {videos.slice(0, 2).map((v, i) => {
      const src = getVideoSrc(v);
      const link = v.link?.trim() || "#";
      const hasLink = link && link !== "#";

      return (
        <div class="plt__videoCol" data-i={i}>
          <div class="plt__videoLabel">{v.label}</div>

        <div class="plt__videoFrame">
        {src ? (
          <>
            <img
              class="plt__poster"
              src={v.poster && v.poster.trim() ? v.poster : "/images/aunty1.jpg"}
              alt={v.label ?? ""}
              loading="lazy"
            />

            <div
              class="plt__videoMount"
              data-src={src}
              data-link={hasLink ? link : undefined}
            ></div>
          </>
        ) : (
          <div class="plt__videoPlaceholder">
            Add a video in Decap (mp4/webm) or paste a URL.
          </div>
        )}
      </div>

        </div>
      );
    })}
  </div>

  <script is:inline>
  (function () {
  const root = document.currentScript?.closest(".plt");
  if (!root) return;

  const isDesktop = window.matchMedia("(min-width: 992px)").matches;

  if (!isDesktop) return; // ðŸ”¥ en mobile no hacemos nada

  root.querySelectorAll(".plt__videoMount").forEach((mount) => {
    const src = mount.getAttribute("data-src");
    if (!src) return;

    const link = mount.getAttribute("data-link");

    const video = document.createElement("video");
    video.className = "plt__video";
    video.src = src;
    video.muted = true;
    video.loop = true;
    video.playsInline = true;
    video.preload = "metadata";

    mount.appendChild(video);

    // Primer frame
    const seek = () => { video.currentTime = 0.001; };
    if (video.readyState >= 1) seek();
    else video.addEventListener("loadedmetadata", seek, { once: true });

    if (link) {
      video.style.cursor = "pointer";
      video.addEventListener("click", () => {
        window.open(link, "_blank", "noopener,noreferrer");
      });
    }

    video.addEventListener("mouseenter", () => {
      video.play().catch(() => {});
    });

    video.addEventListener("mouseleave", () => {
      video.pause();
      video.currentTime = 0.001;
    });
  });
})();

  </script>

  <style>
   
  </style>
</section>